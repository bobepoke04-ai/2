---
- name: Backup Huawei Firewall (Project backups folder)
  hosts: bj
  gather_facts: false

  vars:
    backup_root: "{{ playbook_dir }}/backups"
    today: "{{ lookup('pipe', 'date +%F') }}"
    timestamp: "{{ lookup('pipe', 'date +%F_%H%M%S') }}"
    keep_days: 30

  tasks:
    - name: Show backup root
      command: bash -lc "pwd; echo playbook_dir={{ playbook_dir }}; ls -la {{ playbook_dir }} | head -n 50"
      changed_when: false

    - name: Create backup directory
      command: mkdir -p "{{ backup_root }}/{{ inventory_hostname }}/{{ today }}"
      changed_when: false

    - name: Disable terminal paging (best effort)
      ansible.netcommon.cli_command:
        command: screen-length 0 temporary
      ignore_errors: true

    - name: Get firewall configuration
      community.network.ce_command:
        commands:
          - display current-configuration
      register: cfg

    - name: Save configuration to file
      copy:
        content: "{{ cfg.stdout[0] | string }}"
        dest: "{{ backup_root }}/{{ inventory_hostname }}/{{ today }}/{{ inventory_hostname }}_{{ timestamp }}.cfg"
        mode: "0644"
    - name: Debug where the file was written
      debug:
        msg:
          - "playbook_dir={{ playbook_dir }}"
          - "backup_root={{ backup_root }}"
          - "expected_file={{ backup_root }}/{{ inventory_hostname }}/{{ today }}/{{ inventory_hostname }}_{{ timestamp }}.cfg"
    - name: Prove whether /runner/project is persistent
      command: bash -lc "ls -ld /runner/project; df -hT /runner/project || true; mount | egrep 'runner/project|local-path|projects' || true"
      changed_when: false

    - name: List cfg files under backup_root (runner view)
      command: bash -lc "ls -la {{ backup_root }}/{{ inventory_hostname }}/{{ today }}; find {{ backup_root }} -type f -name '*.cfg' | tail -n 20"
      changed_when: false
    - name: Cleanup old backups (best effort)
      shell: |
        find "{{ backup_root }}/{{ inventory_hostname }}" -type f -name "*.cfg" -mtime +{{ keep_days }} -delete
      args:
        executable: /bin/bash
      changed_when: false
      failed_when: false
